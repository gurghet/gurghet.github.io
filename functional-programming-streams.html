<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Zena Software</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Consulenza tecnologie Big Data e Cloud">
    
    <link rel="preload" href="/assets/css/0.styles.eb95a9dd.css" as="style"><link rel="preload" href="/assets/js/app.a2df8847.js" as="script"><link rel="preload" href="/assets/js/2.61b454c1.js" as="script"><link rel="preload" href="/assets/js/10.13e980c8.js" as="script"><link rel="prefetch" href="/assets/js/11.4fda546e.js"><link rel="prefetch" href="/assets/js/12.0ae2261a.js"><link rel="prefetch" href="/assets/js/13.5c1f4866.js"><link rel="prefetch" href="/assets/js/14.bdc856fe.js"><link rel="prefetch" href="/assets/js/15.e89b47ed.js"><link rel="prefetch" href="/assets/js/16.5ea0211c.js"><link rel="prefetch" href="/assets/js/3.2fb56fba.js"><link rel="prefetch" href="/assets/js/4.09f84c1d.js"><link rel="prefetch" href="/assets/js/5.2f0f6adc.js"><link rel="prefetch" href="/assets/js/6.40cfdc13.js"><link rel="prefetch" href="/assets/js/7.35a44985.js"><link rel="prefetch" href="/assets/js/8.6759414c.js"><link rel="prefetch" href="/assets/js/9.5055760e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.eb95a9dd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Zena Software</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>Learning functional programming</p> <p>Advanced track</p></blockquote> <p>In this series I want to explore fundamental concepts and tools of functional programming by building small applications.</p> <h1 id="streams"><a href="#streams" class="header-anchor">#</a> Streams</h1> <iframe width="560" height="315" src="https://www.youtube.com/embed/sXYceYCLUZw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen="allowfullscreen"></iframe> <p>A stream is a conceptual device that abstracts the way in wich we access and process data. A stream at its core is just a sequence of data. However, differently from an array or a list, a stream doesn't necessarily have a beginning or an end.</p> <p>In real life we have some example of streams. A ticker for the price of Bitcoin for example. It's a stream because it's clearly a timed sequence of data. It does have a beginning (when Bitcoin was created) but it never ends.</p> <h2 id="building-a-bitcoin-price-ticker"><a href="#building-a-bitcoin-price-ticker" class="header-anchor">#</a> Building a Bitcoin price ticker</h2> <p>In this issue you'll build a BTC ticker that runs on your screen. This way you will always know when to buy and when to sell.</p> <h3 id="design"><a href="#design" class="header-anchor">#</a> Design</h3> <div style="margin:20px;"><img alt="Design draft for the BTC ticker" src="/assets/img/design-draft-for-the-bitcoin-ticker.8a97413d.png" height="300"></div> <p>A simple design you can draft in two seconds is the one sketched above. We'll chose some API, parse the output, turn it into a number and finally print it on our screen (or physical ticker if you are retro).</p> <p><img src="/assets/img/gomez-examining-a-stock-ticker.b61995f1.png" alt="Gomez Addams inspecting a stock ticker"></p> <h3 id="programming"><a href="#programming" class="header-anchor">#</a> Programming</h3> <p>A very first draft of the program might be like this:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>ZStream
  <span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token string">&quot;100.000&quot;</span><span class="token punctuation">)</span> <span class="token comment">// generate some fake data</span>
  <span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// let's not overload</span>
  <span class="token punctuation">.</span>map<span class="token punctuation">(</span>identity<span class="token punctuation">)</span> <span class="token comment">// placeholder for parsing</span>
  <span class="token punctuation">.</span>map<span class="token punctuation">(</span>priceString <span class="token keyword">=&gt;</span> BigDecimal<span class="token punctuation">(</span>priceString<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>price <span class="token keyword">=&gt;</span>
    putStrLn<span class="token punctuation">(</span>
      s<span class="token string">&quot;BTC-EUR: ${price.setScale(2, BigDecimal.RoundingMode.UP)}&quot;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
</code></pre></div><p>You can go ahead and <a href="https://scastie.scala-lang.org/hwQEk38eTOCfYYrEjhne2Q" target="_blank" rel="noopener noreferrer">launch this<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. In the first line we are getting a hold of the <code>ZStream</code> object, it contains the <code>repeat</code> method wich just infinitely produces whatever we pass: a string in this case. We limit it to 3 strings, otherwise it will just overload our machine and never stop. The parsing for now is impersonated by an identity function. We then leverage the <code>BigDecimal</code> parsing capabilities to have a number to work with. Lastly the <code>foreach</code> method is used, which is a terminal method. It will wrap up the stream by printing on the screen a well formatted price tick.</p> <p>We could have even skipped the conversion to <code>BigDecimal</code> and back if we don't care about having control on rounding.</p> <div class="language-scala extra-class"><pre class="language-scala"><code>ZStream
  <span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token string">&quot;100.000&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>map<span class="token punctuation">(</span>identity<span class="token punctuation">)</span>
  <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>price <span class="token keyword">=&gt;</span> putStrLn<span class="token punctuation">(</span>s<span class="token string">&quot;BTC-EUR: $price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Now we go hunting for a good API. Like in the cooking TV show I’ve already done this, but you can look for yourself and I recommend <a href="https://www.programmableweb.com/" target="_blank" rel="noopener noreferrer">ProgrammableWeb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>I’m going to use the <a href="https://api.kraken.com/0/public/Ticker?pair=BTCEUR" target="_blank" rel="noopener noreferrer">Kraken public API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> which is very basic. It returns a json of this form:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;XXBTZEUR&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            ... other stuff
            <span class="token property">&quot;c&quot;</span><span class="token operator">:</span> <span class="token string">&quot;last trade price&quot;</span><span class="token punctuation">,</span>
            ... other stuff
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>We are interested in the current price which is the last trade price. We could (and should) use a json parser to extract this. However that would open a can of worms, so I’m going to use a regular expression:
</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> parsePrice<span class="token punctuation">(</span>json<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> regex <span class="token operator">=</span> raw<span class="token triple-quoted-string string">&quot;&quot;&quot;(?s).*&quot;c&quot;:\[&quot;([0-9.]+).*&quot;&quot;&quot;</span><span class="token punctuation">.</span>r
  json <span class="token keyword">match</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> regex<span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> price
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So we have our parsing step, we finally need to actually call the API. Again, there are super-cool http clients we could use; instead for simplicity's sake we'll use the scala built-in client.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> tickerURLCall<span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> IO<span class="token punctuation">(</span>
  io<span class="token punctuation">.</span>Source
    <span class="token punctuation">.</span>fromURL<span class="token punctuation">(</span><span class="token string">&quot;https://api.kraken.com/0/public/Ticker?pair=BTCEUR&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>mkString
<span class="token punctuation">)</span>
</code></pre></div><p>We can now put everything together in the program. We will use <code>tickerURLCall</code> instead of the fake data and the <code>priceParce</code> instead of the identity.</p> <div class="language-scala extra-class"><pre class="language-scala"><code>  <span class="token keyword">val</span> program<span class="token operator">:</span> ZIO<span class="token punctuation">[</span>Console <span class="token keyword">with</span> Clock<span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> <span class="token builtin">Unit</span><span class="token punctuation">]</span> <span class="token operator">=</span> ZStream
    <span class="token punctuation">.</span>repeatEffect<span class="token punctuation">(</span>tickerURLCall<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>throttleShape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5.</span>seconds<span class="token punctuation">)</span><span class="token punctuation">(</span>_ <span class="token keyword">=&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// let's slow down</span>
    <span class="token punctuation">.</span>map<span class="token punctuation">(</span>parsePrice<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>price <span class="token keyword">=&gt;</span>
      putStrLn<span class="token punctuation">(</span>
        s<span class="token string">&quot;BTC-EUR: $price&quot;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>Node the addition of the <code>throttleShape</code> function. This is because we don't want to call the API as fast as we can, but we want a constant slow rate. The code says 1 call every 5 seconds. The function we supply in the second pair of brakets is a function to compute the weight of the result (to shape the throttle accordingly) we conside all responses equal to 1.</p> <p>This last feature is useful if you have pagination and you don't know how many items you have for each page. You could create a stream that outputs 10 items per minute and sometimes the calls to the source API return more (or less). Then the API would be called more slowly (or faster) to compensate.</p> <p>Also we don't need to limit the number of ticks with <code>take(3)</code> now that we have throttling in place.</p> <p>You can <a href="https://scastie.scala-lang.org/8nRhWur0TEqgSbfayn3JOA" target="_blank" rel="noopener noreferrer">test the bitcoin ticker on Scastie<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> remember to edit it to display your favourite currency pair and your favourite rounding.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a2df8847.js" defer></script><script src="/assets/js/2.61b454c1.js" defer></script><script src="/assets/js/10.13e980c8.js" defer></script>
  </body>
</html>
